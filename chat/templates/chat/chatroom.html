{% extends "base.html" %}
{% load top_recommend %}
{% load static %}
{% block get_in_head %}

{% include "snippets/emojipicker/emoji_css.html" %}
<link rel="stylesheet" type="text/css" href="{% static "css/chat.css" %}">

{% endblock get_in_head %}


{% block main_content %}

<div class="row">
    <!-- side left-->
  	 <div class="col-md-3 d-none d-md-block order-md-1">
  	 	{% if user.is_authenticated %}
  	 		{% include "snippets/profile_card.html" %}
  	 	{% endif %}
        <!-- top recommend-->
    	{%top_recommend%}
    	<!-- end top recommend-->
    </div>
    <!-- end side left-->

    <!-- main content-->
    <div class="col-md-6 order-1 order-md-2 ">
    		{% if user.is_authenticated %}
    			<!-- Post Create-->
	            {% include "snippets/post_create.html" %}
	            <!-- Post CreateEnd-->
    		{% endif %}
            
        
                <!-- chat -->
		        <div class="content-chat">
		           <!-- Contact List-->
                  <ul id="room" class="room-wraper">
                    <div id="roomList" class="row justify-content-around m-0">
                      <!--all room chat-->
                    </div>
                    <div class="add-room dropdown d-flex">
                      <a href="javascript:void(0)"class="btn btn-orange btn-custom ml-auto" data-toggle="dropdown"><i class="fa fa-plus"></i></a>
                      <div class="dropdown-menu">
                        <ul class="add-list-room">
                          {% for c in contact  %}
                            <li><a href="javascript:void(0)" title="{{c.username}}" class="list-room btn-add-room" data-id='{{c.id}}' data-new='true'><img src="{{c.profile.user_photo.url}}" alt="user" class="profile-photo" /> <span class="name-user">{{c.username}}</span></a></li>
                          {%empty%}
                            <p>Anda belum mengikuti creator manapun</p>
                          {% endfor %}
                          
                        </ul>
                      </div>
                    </div>
                  </ul><!--Contact List End-->
                  <!--messages -->
                  <div class="room-messages" id="wrap-messages" style="display:none">
                    <!--infoprofile -->
                    <div class="card-header msg_head">
                      <div class="d-flex">
                        <div class="btn-back" id="show-room-list">
                          <i class="fa fa-angle-left"></i>
                        </div>
                        <div class="img_cont">
                          <img id="room_photo" src="{{user.profile.user_photo.url}}" alt="" class="profile-photo"/>
                          <span class="online_icon"></span>
                        </div>
                        <div class="user_info ml-4">
                          <span id="room_name">
                            <!--user chat-->
                          </span>
                        </div>
                      </div>
                      <span id="action_menu_btn"><i class="fa fa-ellipsis-v"></i></span>
                      <div class="action_menu">
                        <ul>
                          <li><i class="fa fa-user-circle"></i> View profile</li>
                          <li><i class="fa fa-plus"></i> Add to group</li>
                          <li><i class="fa fa-ban"></i> Block</li>
                        </ul>
                      </div>
                    </div>
                     <!--infoprofile end -->
                    <!--body chat -->
                  	<div class="chat-body">
                        <button id="btn-old-msg" class="btn btn-outline-orange" style="display:none">Chat Sebelum</button>
                        <ul class="chat-message">

                          <!--all chat-->
                        </ul>
                        <!--form chat -->
                        <div class="form-chat">
                          <div class="input-container mb-2">
                             <textarea data-emojiable=true id="chat-message" data-emoji-input="unicode">
                            
                            </textarea>
                          </div>
                          <div class="d-flex">
                              <button id="btn-send-msg" class=" btn btn-orange ml-auto">
                                Send
                              </button>
                            </div>
                        </div>
                         <!--form chat -->
                      </div>
                      <!--body chat -->
                      
                  </div>
                   <!--messages -->

		        </div>
		        <!-- end chat-->

    </div>
    <!-- end main content-->

     <!-- side right-->
    <div class="col-md-3 order-2 order-md-3">
    	
	     <!--forum recommend-->
      {%forum_recommend request%}
       <!--end forum recommend-->
	   	{% include "snippets/footer.html" %}
	 </div>
   <!-- end side right-->
</div>

{% endblock main_content %}

{% block costum_js %}

  {% include "snippets/follow.html" %}
  {% include "snippets/emojipicker/emoji_js.html" %}

  <script type="text/javascript" src='{% static "vendor/reconnecting-websocket/reconnecting-websocket.min.js" %}'></script>
  <script type="text/javascript">

    let username='alen';
    //room socket
    let node='ws://'+window.location.host+'/ws/chat/'
    let roomSocket=new ReconnectingWebSocket(node);
    roomSocket.onopen=function(e){
      fetchRoom()
    };
    roomSocket.onmessage=function(e){
      let data=JSON.parse(e.data);
      if(data['command']=='fetch_room'){
        $('#roomList').html('')
        for (let i=0;i<data['data_room'].length;i++){
          createRoom(data['data_room'][i])
        }
      }
    }

    function fetchRoom(){
      roomSocket.send(JSON.stringify({
        'command':'fetch_room'
      }))
    }

    function createRoom(data){
      let name=data['name']
      let room_id=data['room_id']
      let image_url=data['image_url']
      let last_msg=data['last_msg']
      let last_msg_time=data['last_msg_time']
      let count_received=data['count_received']

      let li_room=document.createElement('li')
      li_room.className='list-room col-12 col-sm-5'
      li_room.setAttribute('data-id',room_id)

      let a_room=document.createElement('a')
      a_room.href="javascript:void(0)"
      let div_contact=document.createElement('div')
      div_contact.className='contact row'
      img_user=document.createElement('img')
      img_user.className='profile-photo'
      img_user.src=image_url
      div_msg=document.createElement('div')
      div_msg.className='msg-preview'
      h6_name=document.createElement('h6')
      h6_name.className='name-user'
      h6_name.textContent=name
      p_msg=document.createElement('p')
      p_msg.className='text-muted'
      if (data['my_msg']){
        p_msg.textContent='Anda: '+last_msg
      }else{
        p_msg.textContent=last_msg
      }
      small_time=document.createElement('small')
      small_time.className='text-muted'
      small_time.textContent=last_msg_time
      

      div_msg.appendChild(h6_name)
      div_msg.appendChild(p_msg)
      div_msg.appendChild(small_time)
      if(count_received>0){
        div_alert=document.createElement('div')
        div_alert.className='chat-alert'
        div_alert.textContent=count_received
        div_msg.appendChild(div_alert)
      }
      

      div_contact.appendChild(img_user)
      div_contact.appendChild(div_msg)

      a_room.appendChild(div_contact)
      li_room.appendChild(a_room)

      $('#roomList')[0].appendChild(li_room)
    }

    roomSocket.onclose=function(e){
      console.error('Room Socket Close')
    };



    let chatSocket=null

    function fetchMessage(){
      chatSocket.send(JSON.stringify({
        'command':'fetch_messages'
      }))
    }


    function showChat(msg,user,pre=false){
      author=msg['author']
      author_img=msg['author_image'],
      text=msg['content']
      time=msg['time']

      let li_chat=document.createElement('li')
      let img_chat=document.createElement('img')
      img_chat.src=author_img

      let div1_chat=document.createElement('div')
      

      if(author==user){
        author='Anda'
        li_chat.className='right'
        img_chat.className='profile-photo float-right'
        div1_chat.className='chat-item float-right'
      }else{
        li_chat.className='left'
        img_chat.className='profile-photo float-left'
        div1_chat.className='chat-item float-left'
      }

     

      let div2_chat=document.createElement('div')
      div2_chat.className='chat-item-header'

      let h5_chat=document.createElement('h5')
      h5_chat.textContent=author

      let small_chat=document.createElement('small')
      small_chat.className='text-muted'
      small_chat.textContent=time

      let p_chat=document.createElement('p')
      p_chat.textContent=text

      div2_chat.appendChild(h5_chat)
      div2_chat.appendChild(small_chat)

      div1_chat.appendChild(div2_chat)
      div1_chat.appendChild(p_chat)

      let div_clearfix=document.createElement('div')
      div_clearfix.className='clearfix'
      li_chat.appendChild(img_chat)
      li_chat.appendChild(div1_chat)
      li_chat.appendChild(div_clearfix)
      msg_list=$('.chat-message')[0]
      if(pre){
        msg_list.prepend(li_chat)
        msg_list.scrollTop=0
      }else{
       msg_list.appendChild(li_chat)
       msg_list.scrollTop=msg_list.scrollHeight
      }
      
      
    }
    function clear_form_msg(){
      let msg=$('#chat-message')
          msg.val('')
          msg.next().text('') 
    }

    let chat_wrap=$('.chat-message')[0]
    chat_wrap.onscroll=function(e){
      if($(this).scrollTop()==0){
        $('#btn-old-msg').fadeIn(300)
      }else{
        $('#btn-old-msg').fadeOut(300)
      }
    };
    
    $(document).on('click','#btn-old-msg',function(){
      let num_show_chat=$('.chat-message').children().length
      chatSocket.send(JSON.stringify({
        'command':'fetch_messages',
        'kind':'old',
        'num_show':num_show_chat,
      }))
    })

    $(document).ready(function(){
      $('#action_menu_btn').click(function(){
        $('.action_menu').toggle();
        });
      });

    $(document).on('click','#show-room-list',function(){
      chatSocket.close()
      $('#wrap-messages').fadeOut(100)
      $('#room').fadeIn(100)
      //update room dan berikan nilai null pada chatSocket
      // fetchMessage()
      fetchRoom()
      $('.chat-message').html('')

    });
    $(document).on('click','.list-room',function(e){      
        data_id=$(this).attr('data-id')
        _new=$(this).attr('data-new')
        if (_new=='true'){
          chatSocket=new ReconnectingWebSocket(node+data_id+'/new/');
        }else{
          chatSocket=new ReconnectingWebSocket(node+data_id+'/ready/');
        }
        room_image=$(this).find('img').attr('src')
        room_name=$(this).find('.name-user').text()
        $('#chat-message').val('')
        $('.emoji-wysiwyg-editor').text('')
        $('#room_photo').attr('src',room_image)
        $('#room_name').text(room_name)
        $('#room').fadeOut(100)
        $('#wrap-messages').fadeIn(100)
        $('#btn-old-msg').removeClass('dont-display')

        chatSocket.onopen=function(e){
          fetchMessage()

        }
        chatSocket.onmessage=function(e){
          data=JSON.parse(e.data)
          if (data['close']){
            console.log('close')
            chatSocket.close()
          }
          let pre=false
          if(data['command']=='fetch_message'){
            messages=data['messages']
            if (messages){
                if(data['pre']){
                pre=true
                }else{
                  $('.chat-message').html('')
                }

              if(data['all_msg']){
                  $('#btn-old-msg').addClass('dont-display')
                }
              for(i=0;i<messages.length;i++){
                user=data['request_user']
                showChat(messages[i],user,pre)
              }
            }else{
              $('#btn-old-msg').addClass('dont-display')
            }
            
          }else if(data['command']=='new_message'){
            user='{{request.user.username}}'
            message=data['msg']
            clear_form_msg()
            showChat(message,user,pre)
          }else if(data['command']=='redirect_socket'){
            chatSocket.url=node+data['room_id']+'/ready/'
            $('#btn-old-msg').addClass('dont-display')
          }
          
        }
        chatSocket.onclose=function(e){
          console.log('chat close')
        }
    });
    $(document).on('click','#btn-send-msg',function(e){
      e.preventDefault()
      let msg=$('#chat-message')
      if(msg.val().trim() && chatSocket.readyState==ReconnectingWebSocket.OPEN){
       chatSocket.send(JSON.stringify({
        'command':'new_message',
        'msg':msg.val().trim()
        }))

        clear_form_msg()
      }
    });

  </script>

{% endblock costum_js %}
